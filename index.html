<!DOCTYPE html>
<html lang="fa" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی‌های رایگان رایگان</title>
    <!-- Favicon (using an emoji as SVG data URI) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🎮</text></svg>">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vazirmatn Font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            direction: rtl; /* برای پشتیبانی از زبان فارسی */
            text-align: right; /* تراز متن به راست */
        }
        /* Dark Mode Styles (default) */
        .dark {
            background: linear-gradient(to bottom right, #1a202c, #2d3748); /* Darker gradient */
            color: #e2e8f0; /* Light text */
        }
        .dark .bg-gray-700 {
            background-color: #4a5568; /* Darker card background */
        }
        .dark .text-gray-400 {
            color: #a0aec0;
        }
        .dark .text-gray-300 {
            color: #cbd5e0;
        }
        .dark .border-gray-600 {
            border-color: #4a5568;
        }
        .dark .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }

        /* Light Mode Styles */
        html.light {
            background: linear-gradient(to bottom right, #f7fafc, #edf2f7); /* Lighter gradient */
            color: #2d3748; /* Dark text */
        }
        html.light .bg-gray-700 {
            background-color: #ffffff; /* White card background */
            border: 1px solid #e2e8f0;
        }
        html.light .text-gray-400 {
            color: #4a5568;
        }
        html.light .text-gray-300 {
            color: #2d3748;
        }
        html.light .border-gray-600 {
            border-color: #e2e8f0;
        }
        html.light .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        html.light .text-white {
            color: #1a202c;
        }
        html.light .bg-clip-text {
            background-image: linear-gradient(to right, #007bff, #6f42c1); /* Adjust gradient for light mode */
        }

        /* Common card styles */
        .game-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            display: flex; /* Ensures content fills height */
            flex-direction: column; /* Stacks content vertically */
        }
        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        .game-card img {
            object-fit: cover; /* Ensures images cover the area without distortion */
            height: 192px; /* Default h-48 */
        }
        .game-card .p-4 {
            flex-grow: 1; /* Allows content area to expand */
            display: flex;
            flex-direction: column;
        }
        /* Default text truncation */
        .game-card .description-text {
            flex-grow: 1;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 4; /* Default to 4 lines */
            -webkit-box-orient: vertical;
            text-overflow: ellipsis;
        }

        /* Custom styles for the theme toggle button */
        #theme-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: background-color 0.3s, color 0.3s, transform 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .dark #theme-toggle {
            background-color: #4a5568;
            color: #f7fafc;
        }
        html.light #theme-toggle {
            background-color: #fff;
            color: #2d3748;
        }
        #theme-toggle:hover {
            transform: scale(1.1);
        }

        /* Scroll buttons */
        .scroll-button {
            position: fixed;
            right: 20px;
            background-color: #3182ce; /* Blue-600 */
            color: white;
            padding: 12px;
            border-radius: 9999px; /* Full rounded */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            z-index: 90;
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0; /* Hidden by default */
            transform: scale(0.9);
        }
        .scroll-button:hover {
            background-color: #2b6cb0; /* Blue-700 */
            transform: scale(1);
        }
        .scroll-button.show {
            opacity: 1;
            transform: scale(1);
        }
        #scroll-to-top {
            bottom: 80px;
        }
        #scroll-to-bottom {
            bottom: 20px;
        }

        /* Responsive layout adjustments based on selected columns */
        /* For 1 column (Large View) */
        .layout-cols-1 .game-card img { height: 320px; /* h-80 */ }
        .layout-cols-1 .game-card h2 { font-size: 2rem; /* text-4xl */ }
        .layout-cols-1 .game-card .description-text { -webkit-line-clamp: 8; }
        .layout-cols-1 .game-card .text-sm { font-size: 1rem; /* text-base */ }

        /* For 2 columns (Medium View) */
        .layout-cols-2 .game-card img { height: 256px; /* h-64 */ }
        .layout-cols-2 .game-card h2 { font-size: 1.75rem; /* text-3xl */ }
        .layout-cols-2 .game-card .description-text { -webkit-line-clamp: 6; }
        .layout-cols-2 .game-card .text-sm { font-size: 0.875rem; /* text-sm */ }

        /* For 3 columns (Small View - Default) */
        .layout-cols-3 .game-card img { height: 192px; /* h-48 */ }
        .layout-cols-3 .game-card h2 { font-size: 1.25rem; /* text-xl */ }
        .layout-cols-3 .game-card .description-text { -webkit-line-clamp: 4; }
        .layout-cols-3 .game-card .text-sm { font-size: 0.875rem; /* text-sm */ }

        /* For 4 columns (Very Small View) */
        .layout-cols-4 .game-card img { height: 160px; /* h-40 */ }
        .layout-cols-4 .game-card h2 { font-size: 1rem; /* text-lg */ }
        .layout-cols-4 .game-card .description-text { -webkit-line-clamp: 3; }
        .layout-cols-4 .game-card .text-sm { font-size: 0.75rem; /* text-xs */ }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 to-gray-800 text-gray-100 min-h-screen p-4 sm:p-8">
    <!-- Theme Toggle Button -->
    <button id="theme-toggle" class="bg-gray-700 text-white rounded-full p-2">
        ☀️
    </button>

    <div class="container mx-auto max-w-7xl">
        <header class="text-center mb-12">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-white mb-4">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-600">
                    بازی‌های رایگان امروز
                </span>
            </h1>
            <p class="text-lg sm:text-xl text-gray-300">
                جدیدترین بازی‌های رایگان از فروشگاه‌های مختلف را اینجا پیدا کنید!
            </p>
        </header>

        <!-- Filter and Layout Options -->
        <div class="mb-8 flex flex-col sm:flex-row items-center justify-center gap-4">
            <!-- Store Filter -->
            <label for="store-filter" class="text-lg font-medium text-gray-300 whitespace-nowrap">
                فیلتر بر اساس فروشگاه:
            </label>
            <select id="store-filter" class="bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-2 focus:ring-blue-500 focus:border-blue-500 w-full sm:w-auto">
                <option value="all">همه فروشگاه‌ها</option>
                <!-- Options will be populated by JavaScript -->
            </select>

            <!-- Content Type Filter -->
            <label for="content-type-filter" class="text-lg font-medium text-gray-300 whitespace-nowrap">
                نوع محتوا:
            </label>
            <select id="content-type-filter" class="bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-2 focus:ring-blue-500 focus:border-blue-500 w-full sm:w-auto">
                <option value="all-content">همه (بازی و افزونه)</option>
                <option value="games-only">فقط بازی</option>
                <option value="dlc-only">فقط DLC و افزونه</option>
            </select>

            <!-- Price Type Filter -->
            <label for="price-type-filter" class="text-lg font-medium text-gray-300 whitespace-nowrap">
                نوع قیمت:
            </label>
            <select id="price-type-filter" class="bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-2 focus:ring-blue-500 focus:border-blue-500 w-full sm:w-auto">
                <option value="all-prices">همه (رایگان و تخفیف)</option>
                <option value="free-only">فقط رایگان</option>
                <option value="discounted-only">فقط تخفیف‌خورده</option>
            </select>

            <!-- Column Selector -->
            <label for="column-selector" class="text-lg font-medium text-gray-300 whitespace-nowrap sm:mr-4">
                تعداد ستون‌ها:
            </label>
            <select id="column-selector" class="bg-gray-700 border border-gray-600 text-white rounded-lg px-4 py-2 focus:ring-blue-500 focus:border-blue-500 w-full sm:w-auto">
                <option value="1">۱ ستون (بزرگ)</option>
                <option value="2">۲ ستون (متوسط)</option>
                <option value="3">۳ ستون (کوچک)</option>
                <option value="4">۴ ستون (خیلی کوچک)</option>
            </select>
        </div>

        <div id="loading" class="text-center text-xl text-blue-400 mb-8">
            در حال بارگذاری بازی‌ها...
        </div>

        <div id="error-message" class="hidden text-center text-xl text-red-400 mb-8">
            خطا در بارگذاری بازی‌ها. لطفاً بعداً دوباره امتحان کنید.
        </div>

        <div id="no-games-message" class="hidden text-center text-xl text-gray-400 mb-8">
            در حال حاضر هیچ بازی رایگانی برای نمایش وجود ندارد.
        </div>

        <!-- games-container will dynamically get grid-cols and layout-cols classes -->
        <div id="games-container" class="grid gap-6"> 
            <!-- Game cards will be injected here by JavaScript -->
        </div>
    </div>

    <!-- Scroll to Top Button -->
    <button id="scroll-to-top" class="scroll-button">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Scroll to Bottom Button -->
    <button id="scroll-to-bottom" class="scroll-button">
        <i class="fas fa-arrow-down"></i>
    </button>

    <script>
        let allGames = []; // To store all fetched games
        const gamesContainer = document.getElementById('games-container');
        const loadingMessage = document.getElementById('loading');
        const errorMessage = document.getElementById('error-message');
        const noGamesMessage = document.getElementById('no-games-message');
        const storeFilter = document.getElementById('store-filter');
        const columnSelector = document.getElementById('column-selector'); // Column selector
        const themeToggle = document.getElementById('theme-toggle');
        const scrollToTopBtn = document.getElementById('scroll-to-top');
        const scrollToBottomBtn = document.getElementById('scroll-to-bottom');
        
        // New filter elements
        const contentTypeFilter = document.getElementById('content-type-filter'); 
        const priceTypeFilter = document.getElementById('price-type-filter'); 

        // نگاشت نام‌های انگلیسی فروشگاه‌ها به نام‌های فارسی برای نمایش
        const storeDisplayMap = {
            "epicgames": "اپیک گیمز", // Changed from "اپیک گیمز (ویندوز)"
            "steam": "استیم",
            "googleplay": "اندروید",
            "epicgames(android)": "اندروید",
            "epicgames(ios)": "آی‌اواس", // Changed to آی‌اواس
            "iosappstore": "آی‌اواس", // Changed to آی‌اواس
            "playstation": "پلی‌استیشن",
            "xbox": "ایکس‌باکس",
            "gog": "GOG",
            "itch.io": "Itch.io",
            "indiegala": "ایندی‌گالا",
            "stove": "STOVE",
            "other": "سایر فروشگاه‌ها",
            "reddit": "ردیت (لینک مستقیم)",
            "android": "اندروید",
            "ios": "آی‌اواس", // Changed to آی‌اواس
            "microsoftstore": "مایکروسافت استور",
            "humblestore": "هامبل استور",
            "fanatical": "فناتیکال",
            "greenmangaming": "گرین من گیمینگ",
            "amazon": "آمازون",
            "blizzard": "بلیزارد",
            "eastore": "EA استور",
            "ubisoftstore": "یوبی‌سافت استور"
        };

        // ترتیب نمایش دلخواه فروشگاه‌ها (بر اساس نام‌های فارسی)
        const storeDisplayOrder = [
            "همه فروشگاه‌ها", // این گزینه همیشه اول است
            "استیم",
            "اپیک گیمز", // Changed
            "اندروید",
            "آی‌اواس", // Changed
            "پلی‌استیشن",
            "ایکس‌باکس",
            "GOG",
            "Itch.io",
            "ایندی‌گالا",
            "STOVE",
            "مایکروسافت استور",
            "هامبل استور",
            "فناتیکال",
            "گرین من گیمینگ",
            "آمازون",
            "بلیزارد",
            "EA استور",
            "یوبی‌سافت استور",
            "ردیت (لینک مستقیم)",
            "سایر فروشگاه‌ها"
        ];

        // نگاشت نام‌های انگلیسی ژانرها به نام‌های فارسی
        const genreDisplayMap = {
            "action": "اکشن",
            "adventure": "ماجراجویی",
            "rpg": "نقش‌آفرینی",
            "strategy": "استراتژی",
            "simulation": "شبیه‌سازی",
            "sports": "ورزشی",
            "puzzle": "پازل",
            "indie": "ایندی",
            "casual": "کژوال",
            "racing": "مسابقه‌ای",
            "fighting": "مبارزه‌ای",
            "horror": "ترسناک",
            "survival": "بقا",
            "shooter": "شوتر",
            "massively multiplayer": "چندنفره آنلاین گسترده",
            "early access": "دسترسی زودهنگام",
            "free to play": "رایگان",
            "arcade": "آرکید",
            "platformer": "پلتفرمر",
            "rhythm": "ریتمیک",
            "educational": "آموزشی",
            "family": "خانوادگی",
            "music": "موسیقی",
            "board game": "بازی رومیزی",
            "card game": "بازی کارتی",
            "visual novel": "رمان تصویری",
            "point & click": "اشاره و کلیک",
            "turn-based": "نوبتی",
            "real-time strategy": "استراتژی هم‌زمان",
            "tower defense": "دفاع از برج",
            "role-playing": "نقش‌آفرینی",
            "open world": "جهان باز",
            "sandbox": "سندباکس",
            "stealth": "مخفی‌کاری",
            "puzzle-platformer": "پلتفرمر پازلی",
            "metroidvania": "مترویدوانیا",
            "roguelike": "روگ‌لایک",
            "rogue-lite": "روگ‌لایت",
            "city-builder": "شهرسازی",
            "grand strategy": "استراتژی بزرگ",
            "wargame": "بازی جنگی",
            "historical": "تاریخی",
            "fantasy": "فانتزی",
            "sci-fi": "علمی تخیلی",
            "cyberpunk": "سایبرپانک",
            "post-apocalyptic": "پساآخرالزمانی",
            "superhero": "ابرقهرمانی",
            "anime": "انیمه",
            "pixel graphics": "گرافیک پیکسلی",
            "2d": "دوبعدی",
            "3d": "سه‌بعدی",
            "vr": "واقعیت مجازی",
            "co-op": "همکاری",
            "multiplayer": "چندنفره",
            "singleplayer": "تک‌نفره",
            "online multi-player": "چندنفره آنلاین",
            "local multi-player": "چندنفره محلی",
            "online co-op": "همکاری آنلاین",
            "local co-op": "همکاری محلی",
            "controller support": "پشتیبانی از کنترلر",
            "full controller support": "پشتیبانی کامل از کنترلر",
            "partial controller support": "پشتیبانی جزئی از کنترلر",
            "steam achievements": "دستاوردها",
            "steam trading cards": "کارت‌های تجاری استیم",
            "steam cloud": "ذخیره ابری استیم",
            "steam workshop": "کارگاه استیم",
            "in-app purchases": "خرید درون برنامه‌ای",
            "rts": "استراتژی هم‌زمان (RTS)",
            "fps": "شوتر اول شخص (FPS)",
            "tps": "شوتر سوم شخص (TPS)",
            "moba": "میدان نبرد آنلاین چندنفره (MOBA)",
            "mmorpg": "نقش‌آفرینی آنلاین چندنفره گسترده (MMORPG)",
            "jrpg": "نقش‌آفرینی ژاپنی (JRPG)",
            "western rpg": "نقش‌آفرینی غربی",
            "visual novel": "رمان تصویری",
            "dating sim": "شبیه‌ساز دوستیابی",
            "farming sim": "شبیه‌ساز کشاورزی",
            "life sim": "شبیه‌ساز زندگی",
            "tycoon": "تایگون",
            "management": "مدیریت",
            "building": "ساخت و ساز",
            "crafting": "ساخت و ساز",
            "survival horror": "وحشت بقا",
            "psychological horror": "وحشت روان‌شناختی",
            "action rpg": "نقش‌آفرینی اکشن",
            "adventure rpg": "نقش‌آفرینی ماجراجویی",
            "puzzle adventure": "ماجراجویی پازلی",
            "hidden object": "اشیاء پنهان",
            "match 3": "جورچین ۳",
            "card battle": "نبرد کارتی",
            "deckbuilding": "ساخت عرشه",
            "board game": "بازی رومیزی",
            "tabletop": "رومیزی",
            "party game": "بازی مهمانی",
            "trivia": "دانستنی‌ها",
            "educational": "آموزشی",
            "family": "خانوادگی",
            "kids": "کودکان",
            "music": "موسیقی",
            "rhythm": "ریتم",
            "dance": "رقص",
            "karaoke": "کارائوکه",
            "exercise": "ورزشی",
            "fitness": "تناسب اندام",
            "vr": "واقعیت مجازی",
            "vr exclusive": "انحصاری واقعیت مجازی",
            "vr support": "پشتیبانی واقعیت مجازی",
            "room-scale": "مقیاس اتاق",
            "seated": "نشسته",
            "standing": "ایستاده",
            "motion controls": "کنترل‌های حرکتی",
            "online pvp": "بازیکن در مقابل بازیکن آنلاین",
            "local pvp": "بازیکن در مقابل بازیکن محلی",
            "online co-op": "همکاری آنلاین",
            "local co-op": "همکاری محلی",
            "split screen": "صفحه تقسیم شده",
            "cross-platform multiplayer": "چندنفره بین پلتفرمی",
            "competitive": "رقابتی",
            "co-op campaign": "کمپین همکاری",
            "pvp": "بازیکن در مقابل بازیکن",
            "co-op": "همکاری",
            "multiplayer": "چندنفره",
            "singleplayer": "تک‌نفره",
            "online": "آنلاین",
            "offline": "آفلاین",
            "local": "محلی",
            "controller": "کنترلر",
            "keyboard": "کیبورد",
            "mouse": "موس",
            "touch": "لمسی",
            "2d": "دوبعدی",
            "3d": "سه‌بعدی",
            "pixel graphics": "گرافیک پیکسلی",
            "voxel": "وکسل",
            "hand-drawn": "نقاشی دستی",
            "stylized": "سبک‌دار",
            "minimalist": "مینیمالیستی",
            "abstract": "انتزاعی",
            "beautiful": "زیبا",
            "atmospheric": "جوگیر",
            "relaxing": "آرامش‌بخش",
            "meditation": "مدیتیشن",
            "horror": "ترسناک",
            "comedy": "کمدی",
            "dark comedy": "کمدی سیاه",
            "satire": "هجو",
            "political": "سیاسی",
            "social commentary": "نقد اجتماعی",
            "dystopian": "دیستوپیایی",
            "utopian": "آرمان‌شهری",
            "surreal": "سورئال",
            "experimental": "تجربی",
            "art game": "بازی هنری",
            "walking simulator": "شبیه‌ساز پیاده‌روی"
        };


        // نگاشت رده‌بندی‌های سنی انگلیسی به نام‌های فارسی
        const ageRatingDisplayMap = {
            "esrb everyone": "ESRB: همه",
            "esrb everyone 10+": "ESRB: همه ۱۰+",
            "esrb teen": "ESRB: نوجوان",
            "esrb mature": "ESRB: بزرگسال",
            "esrb adults only": "ESRB: فقط بزرگسالان",
            "pegi 3": "PEGI: ۳+",
            "pegi 7": "PEGI: ۷+",
            "pegi 12": "PEGI: ۱۲+",
            "pegi 16": "PEGI: ۱۶+",
            "pegi 18": "PEGI: ۱۸+",
            "cero a": "CERO: A (همه سنین)",
            "cero b": "CERO: B (۱۲+)",
            "cero c": "CERO: C (۱۵+)",
            "cero d": "CERO: D (۱۷+)",
            "cero z": "CERO: Z (۱۸+)",
            "rating pending": "رده‌بندی در دست بررسی",
            "rp": "رده‌بندی در دست بررسی",
            "ao": "فقط بزرگسالان",
            "m": "بالغ",
            "t": "نوجوان",
            "e": "همه",
            "e10+": "همه ۱۰+",
            // Add more as needed
        };


        // Function to set the theme
        function setTheme(isDark) {
            if (isDark) {
                document.documentElement.classList.add('dark');
                document.documentElement.classList.remove('light');
                themeToggle.textContent = '☀️'; // Sun icon for light mode toggle
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.add('light');
                document.documentElement.classList.remove('dark');
                themeToggle.textContent = '🌙'; // Moon icon for dark mode toggle
                localStorage.setItem('theme', 'light');
            }
        }

        // Initialize theme based on local storage or Tehran time
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                setTheme(savedTheme === 'dark');
            } else {
                // Determine theme based on Tehran time
                const now = new Date();
                const tehranTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tehran' }));
                const hour = tehranTime.getHours();
                // Assume day from 6 AM to 6 PM (18:00)
                const isDayTimeInTehran = hour >= 6 && hour < 18;
                setTheme(!isDayTimeInTehran); // Default to dark if it's night in Tehran
            }
        }

        // Function to apply column layout and sizing
        function applyColumnLayout(columns) {
            // Remove existing grid-cols classes
            gamesContainer.classList.remove('grid-cols-1', 'sm:grid-cols-2', 'lg:grid-cols-3', 'xl:grid-cols-4',
                                         'sm:grid-cols-1', 'sm:grid-cols-2', 'sm:grid-cols-3', 'sm:grid-cols-4',
                                         'lg:grid-cols-1', 'lg:grid-cols-2', 'lg:grid-cols-3', 'lg:grid-cols-4',
                                         'xl:grid-cols-1', 'xl:grid-cols-2', 'xl:grid-cols-3', 'xl:grid-cols-4');
            
            // Add grid-cols for selected number of columns (responsive across all breakpoints)
            gamesContainer.classList.add(`grid-cols-1`, `sm:grid-cols-${columns}`, `lg:grid-cols-${columns}`, `xl:grid-cols-${columns}`);

            // Remove existing layout-cols classes
            gamesContainer.classList.remove('layout-cols-1', 'layout-cols-2', 'layout-cols-3', 'layout-cols-4');
            // Add new layout-cols class
            gamesContainer.classList.add(`layout-cols-${columns}`);

            // Save preference to local storage
            localStorage.setItem('selectedColumns', columns);

            // Re-render games to apply new sizing (though CSS handles most of it)
            applyFilter(); // This will re-render with current filter and new layout
        }

        // Function to render games based on filter
        function renderGames(gamesToRender) {
            gamesContainer.innerHTML = ''; // Clear existing games
            if (gamesToRender.length === 0) {
                noGamesMessage.classList.remove('hidden');
                return;
            } else {
                noGamesMessage.classList.add('hidden');
            }

            gamesToRender.forEach(game => {
                const gameCard = document.createElement('div');
                // Note: The layout-cols-* class is applied to gamesContainer,
                // and the CSS rules target elements within .game-card based on that.
                gameCard.className = 'game-card bg-gray-700 rounded-xl shadow-lg overflow-hidden flex flex-col transform hover:scale-105 transition duration-300 ease-in-out';

                // Placeholder image if image_url is missing or broken
                const imageUrl = game.image_url || `https://placehold.co/600x338/374151/D1D5DB?text=${encodeURIComponent(game.title || 'تصویر موجود نیست').replace(/'/g, "%27")}`;
                
                // Use persian_summary if available, otherwise description
                const displayDescription = game.persian_summary || game.description || 'توضیحات موجود نیست.';

                let storeInfoHtml = '';
                let getGameButtonText = 'دریافت بازی';
                let getGameButtonClass = 'bg-blue-600 hover:bg-blue-700'; // Default for free games

                // Determine store display name
                let displayStoreName = game.store ? game.store.toLowerCase() : '';
                if (displayStoreName === 'google play' || displayStoreName === 'epic games (android)') {
                    displayStoreName = 'android';
                } else if (displayStoreName === 'ios app store' || displayStoreName === 'epic games (ios)') {
                    displayStoreName = 'ios';
                }
                // Normalize for map lookup (remove spaces)
                displayStoreName = storeDisplayMap[displayStoreName.replace(/\s/g, '')] || game.store; // Get Persian name

                let dlcOrAddonTag = '';
                if (game.is_dlc_or_addon) {
                    dlcOrAddonTag = `<span class="bg-purple-600 text-white text-xs font-semibold px-2.5 py-0.5 rounded-full mr-2">DLC/افزونه</span>`;
                }

                if (game.is_free === false) { // If it's a discounted item
                    // Ensure the store name is normalized for display map lookup
                    const normalizedStoreForDisplay = game.store ? game.store.toLowerCase().replace(/\s/g, '') : '';
                    const originalStoreDisplay = storeDisplayMap[normalizedStoreForDisplay] || game.store;
                    storeInfoHtml = `<p class="text-gray-400 mb-3">فروشگاه: ${dlcOrAddonTag}<span class="font-medium text-red-400">تخفیف‌خورده</span> از <span class="font-medium text-purple-300">${originalStoreDisplay}</span></p>`;
                    if (game.discount_text) {
                        storeInfoHtml += `<p class="text-gray-400 mb-3"><span class="font-medium text-orange-400">جزئیات تخفیف:</span> ${game.discount_text}</p>`;
                    }
                    getGameButtonText = 'مشاهده تخفیف';
                    getGameButtonClass = 'bg-green-600 hover:bg-green-700'; // Different color for discounted games
                } else { // If it's a truly free game
                    // Map raw store name to consolidated display name
                    let displayStoreName = game.store.toLowerCase();
                    if (displayStoreName === 'google play' || displayStoreName === 'epic games (android)') {
                        displayStoreName = 'android';
                    } else if (displayStoreName === 'ios app store' || displayStoreName === 'epic games (ios)') {
                        displayStoreName = 'ios';
                    }
                    // Normalize for map lookup (remove spaces)
                    displayStoreName = storeDisplayMap[displayStoreName.replace(/\s/g, '')] || game.store; // Get Persian name
                    storeInfoHtml = `<p class="text-gray-400 mb-3">فروشگاه: ${dlcOrAddonTag}<span class="font-medium text-purple-300">${displayStoreName}</span></p>`;
                }
                
                // Format scores and genres
                const metacriticScore = game.metacritic_score ? `<p class="text-sm text-gray-300"><i class="fas fa-star text-yellow-400"></i> <span class="font-semibold">متاکریتیک (منتقدان):</span> ${game.metacritic_score}/100</p>` : '';
                const metacriticUserScore = game.metacritic_userscore ? `<p class="text-sm text-gray-300"><i class="fas fa-users text-green-400"></i> <span class="font-semibold">متاکریتیک (کاربران):</span> ${game.metacritic_userscore}/10</p>` : '';
                
                // Steam Scores - now with overall and recent
                const steamOverallScore = game.steam_overall_score ? `<p class="text-sm text-gray-300"><i class="fab fa-steam text-blue-400"></i> <span class="font-semibold">استیم (کلی):</span> ${game.steam_overall_score}% (${game.steam_overall_reviews_count || 0} رای)</p>` : '';
                const steamRecentScore = game.steam_recent_score ? `<p class="text-sm text-gray-300"><i class="fab fa-steam-square text-blue-300"></i> <span class="font-semibold">استیم (اخیر):</span> ${game.steam_recent_score}% (${game.steam_recent_reviews_count || 0} رای)</p>` : '';

                // Use translated genres
                const displayGenres = (game.persian_genres && game.persian_genres.length > 0) 
                                            ? game.persian_genres.map(g => genreDisplayMap[g.toLowerCase()] || g).join(', ')
                                            : (game.genres && game.genres.length > 0 ? game.genres.map(g => genreDisplayMap[g.toLowerCase()] || g).join(', ') : '');
                const genresHtml = displayGenres ? `<p class="text-sm text-gray-300"><i class="fas fa-tags text-pink-400"></i> <span class="font-semibold">ژانرها:</span> ${displayGenres}</p>` : '';
                
                const trailerLink = game.trailer ? `<a href="${game.trailer}" target="_blank" class="text-blue-400 hover:underline text-sm mt-2 block"><i class="fas fa-film"></i> مشاهده تریلر</a>` : '';

                let playerInfo = '';
                if (game.is_multiplayer && game.is_online) {
                    playerInfo = `<p class="text-sm text-gray-300"><i class="fas fa-users-line text-cyan-400"></i> <span class="font-semibold">تعداد بازیکن:</span> چندنفره (آنلاین)</p>`;
                } else if (game.is_multiplayer) {
                    playerInfo = `<p class="text-sm text-gray-300"><i class="fas fa-users text-cyan-400"></i> <span class="font-semibold">تعداد بازیکن:</span> چندنفره (آفلاین)</p>`;
                } else if (game.is_online) {
                    playerInfo = `<p class="text-sm text-gray-300"><i class="fas fa-globe text-cyan-400"></i> <span class="font-semibold">تعداد بازیکن:</span> تک‌نفره (آنلاین)</p>`;
                } else {
                    playerInfo = `<p class="text-sm text-gray-300"><i class="fas fa-user text-cyan-400"></i> <span class="font-semibold">تعداد بازیکن:</span> تک‌نفره</p>`;
                }

                // Use translated age rating
                const displayAgeRating = (game.persian_age_rating && ageRatingDisplayMap[game.persian_age_rating.toLowerCase()]) 
                                             ? ageRatingDisplayMap[game.persian_age_rating.toLowerCase()] 
                                             : (game.age_rating && ageRatingDisplayMap[game.age_rating.toLowerCase()] ? ageRatingDisplayMap[game.age_rating.toLowerCase()] : game.age_rating || '');
                const ageRatingHtml = displayAgeRating ? `<p class="text-sm text-gray-300"><i class="fas fa-child text-orange-400"></i> <span class="font-semibold">رده‌بندی سنی:</span> ${displayAgeRating}</p>` : '';


                gameCard.innerHTML = `
                    <img src="${imageUrl}" alt="${game.title || 'تصویر بازی'}">
                    <div class="p-4 flex flex-col flex-grow">
                        <h2 class="font-bold text-white mb-2">${game.title || 'بدون عنوان'}</h2>
                        ${storeInfoHtml}
                        <p class="text-gray-300 mb-4 description-text">${displayDescription}</p>
                        <div class="mt-auto pt-3 border-t border-gray-600 space-y-1">
                            ${metacriticScore}
                            ${metacriticUserScore}
                            ${steamOverallScore}
                            ${steamRecentScore}
                            ${genresHtml}
                            ${playerInfo}
                            ${ageRatingHtml}
                            ${trailerLink}
                            <a href="${game.url}" target="_blank" class="mt-4 block w-full text-center ${getGameButtonClass} text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200">
                                ${getGameButtonText}
                            </a>
                        </div>
                    </div>
                `;
                gamesContainer.appendChild(gameCard);
            });
        }

        // Function to apply filter
        function applyFilter() {
            const selectedStoreFilterValue = storeFilter.value;
            const selectedContentTypeFilterValue = contentTypeFilter.value; 
            const selectedPriceTypeFilterValue = priceTypeFilter.value;     

            const filteredGames = allGames.filter(game => {
                // Step 1: Filter by Content Type
                let passesContentTypeFilter = false;
                if (selectedContentTypeFilterValue === 'all-content') {
                    passesContentTypeFilter = true; 
                } else if (selectedContentTypeFilterValue === 'games-only') {
                    passesContentTypeFilter = !game.is_dlc_or_addon; 
                } else if (selectedContentTypeFilterValue === 'dlc-only') {
                    passesContentTypeFilter = game.is_dlc_or_addon; 
                }

                // Step 2: Filter by Price Type
                let passesPriceTypeFilter = false;
                if (selectedPriceTypeFilterValue === 'all-prices') {
                    passesPriceTypeFilter = true; 
                } else if (selectedPriceTypeFilterValue === 'free-only') {
                    passesPriceTypeFilter = game.is_free; 
                } else if (selectedPriceTypeFilterValue === 'discounted-only') {
                    passesPriceTypeFilter = !game.is_free; 
                }

                // Step 3: Filter by Store
                let passesStoreFilter = true;
                if (selectedStoreFilterValue !== 'all') {
                    const gameStoreRaw = game.store ? game.store.toLowerCase().replace(/\s/g, '') : '';

                    if (selectedStoreFilterValue === 'android') {
                        passesStoreFilter = (gameStoreRaw === 'googleplay' || gameStoreRaw === 'epicgames(android)');
                    } else if (selectedStoreFilterValue === 'ios') {
                        passesStoreFilter = (gameStoreRaw === 'iosappstore' || gameStoreRaw === 'epicgames(ios)');
                    } else {
                        passesStoreFilter = gameStoreRaw === selectedStoreFilterValue;
                    }
                }
                
                return passesContentTypeFilter && passesPriceTypeFilter && passesStoreFilter;
            });
            renderGames(filteredGames);
        }

        // --- Scroll Button Logic ---
        function toggleScrollButtons() {
            // Show "to top" button if scrolled down
            if (window.scrollY > 200) {
                scrollToTopBtn.classList.add('show');
            } else {
                scrollToTopBtn.classList.remove('show');
            }

            // Show "to bottom" button if not at the very bottom
            const scrollHeight = document.documentElement.scrollHeight;
            const clientHeight = document.documentElement.clientHeight;
            const scrollTop = document.documentElement.scrollTop;

            // Check if user is near the bottom (e.g., within 200px from bottom)
            if (scrollTop + clientHeight < scrollHeight - 200) {
                scrollToBottomBtn.classList.add('show');
            } else {
                scrollToBottomBtn.classList.remove('show');
            }
        }

        // Event listeners for scroll buttons
        scrollToTopBtn.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        scrollToBottomBtn.addEventListener('click', () => {
            window.scrollTo({ top: document.documentElement.scrollHeight, behavior: 'smooth' });
        });

        // Listen for scroll events to show/hide buttons
        window.addEventListener('scroll', toggleScrollButtons);
        // Initial check on load
        window.addEventListener('load', toggleScrollButtons);


        document.addEventListener('DOMContentLoaded', async () => {
            initializeTheme(); // Set initial theme

            // Event listener for theme toggle
            themeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.contains('dark');
                setTheme(!isDark);
            });

            try {
                const response = await fetch('web_data/free_games.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allGames = await response.json(); // Store all games globally

                loadingMessage.classList.add('hidden'); // Hide loading message

                if (allGames.length === 0) {
                    noGamesMessage.classList.remove('hidden'); // Show no games message
                    return;
                }

                // Populate store filter options with custom order and Persian names
                const rawUniqueStores = [...new Set(allGames.map(game => game.store))].filter(Boolean); 
                const filterOptionsData = [];
                const addedDisplayNames = new Set(); 

                rawUniqueStores.forEach(store => {
                    const normalizedStore = store.toLowerCase();
                    let filterValue = normalizedStore.replace(/\s/g, '');
                    let displayText;

                    if (normalizedStore === 'google play' || normalizedStore === 'epic games (android)') {
                        filterValue = 'android';
                        displayText = 'اندروید';
                    } 
                    else if (normalizedStore === 'ios app store' || normalizedStore === 'epic games (ios)') {
                        filterValue = 'ios';
                        displayText = 'آی‌اواس'; // Changed to آی‌اواس
                    } else {
                        displayText = storeDisplayMap[filterValue] || store;
                    }

                    if (!addedDisplayNames.has(displayText)) { 
                        filterOptionsData.push({ value: filterValue, text: displayText });
                        addedDisplayNames.add(displayText);
                    }
                });

                filterOptionsData.sort((a, b) => {
                    const indexA = storeDisplayOrder.indexOf(a.text);
                    const indexB = storeDisplayOrder.indexOf(b.text);
                    
                    if (indexA === -1 && indexB === -1) {
                        return a.text.localeCompare(b.text, 'fa', { sensitivity: 'base' });
                    }
                    if (indexA === -1) return 1; 
                    if (indexB === -1) return -1;
                    
                    return indexA - indexB;
                });

                storeFilter.innerHTML = '';
                const newAllOption = document.createElement('option');
                newAllOption.value = 'all';
                newAllOption.textContent = 'همه فروشگاه‌ها';
                storeFilter.appendChild(newAllOption);

                filterOptionsData.forEach(storeObj => {
                    const option = document.createElement('option');
                    option.value = storeObj.value;
                    option.textContent = storeObj.text;
                    storeFilter.appendChild(option);
                });

                // Set default display modes
                contentTypeFilter.value = 'all-content'; // Default to show all content types
                priceTypeFilter.value = 'all-prices';     // Default to show all price types
                
                // Determine initial columns based on device width or saved preference
                const savedColumns = localStorage.getItem('selectedColumns');
                let initialColumns;
                const isMobile = window.innerWidth < 768; // Tailwind's 'sm' breakpoint

                if (isMobile) {
                    initialColumns = 1; // Default to 1 column for mobile
                } else {
                    initialColumns = savedColumns ? parseInt(savedColumns) : 3; // Default to 3 for desktop
                }
                
                columnSelector.value = initialColumns;
                applyColumnLayout(initialColumns); // Apply initial layout

                // Event listeners for new filters
                contentTypeFilter.addEventListener('change', applyFilter);
                priceTypeFilter.addEventListener('change', applyFilter);
                storeFilter.addEventListener('change', applyFilter); // Existing listener
                
                columnSelector.addEventListener('change', (event) => {
                    applyColumnLayout(parseInt(event.target.value));
                });

            } catch (error) {
                console.error('Error fetching games:', error);
                loadingMessage.classList.add('hidden');
                errorMessage.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
